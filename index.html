<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<head>
    <title>Yichen's Gift</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload" href="River_flow_in_you.mp3" as="audio" type="audio/mpeg">
    <link rel="dns-prefetch" href="https://nothinganything.github.io/YichenGifts/">
    <link rel="preconnect" href="https://nothinganything.github.io/YichenGifts/">

    <style>
        /* 加载动画样式 */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #c20cd3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 原有样式 */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* 修改心形容器样式 */
        .heart-container {
            position: fixed;
            display: inline-block;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* 修改心形文字样式 */
        .heart {
            font-family: 'Brush Script MT', cursive;
            position: fixed;
            bottom: 20%; /* 调整到更上方的位置 */
            left: 50%;
            transform: translateX(-50%);
            color: #c20cd3;
            font-size: clamp(24px, 4vw, 65px);
            animation: fadeIn 2s;
            font-weight: bold;
            white-space: nowrap;
            display: none;
            z-index: 1000;
        }

        .name {
            font-family: 'Brush Script MT', cursive;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #c20cd3;
            font-size: clamp(28px, 5vw, 70px);
            font-weight: bold;
            white-space: nowrap;
            display: none;
            animation: flash 2s infinite;
        }

        /* 侧边文字基础样式 */
        .side-text {
            font-family: 'Brush Script MT', cursive;
            font-size: clamp(23px, 3vw, 50px);
            color: #f763ef;
            font-weight: bold;
            position: fixed;
            display: none;
            animation: flash 2s infinite;
            line-height: 1.5;
            z-index: 1000;
        }

        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
        }

        /* PC端默认位置 */
        .left-text-1 { 
            left: calc(15% + 2vw); 
            top: 10%; 
        }
        .left-text-3 { 
            left: calc(22% + 2vw); 
            top: 22%; 
        }
        .right-text-1 { 
            right: calc(15% + 2vw); 
            top: 10%; 
        }
        .right-text-3 { 
            right: calc(22% + 2vw); 
            top: 22%; 
        }

        /* 移动端（手机）样式 */
        @media screen and (max-width: 480px) {
            .side-text {
                font-size: clamp(22px, 5vw, 28px) !important; /* 减小字体大小 */
                line-height: 1.3;
            }
            .left-text-1 { 
                left: 5%; 
                top: 9%; /* 往上移 */
            }
            .left-text-3 { 
                left: 17%; 
                top: 22%; /* 往上移 */
            }
            .right-text-1 { 
                right: 5%; 
                top: 9%; /* 往上移 */
            }
            .right-text-3 { 
                right: 17%; 
                top: 22%; /* 往上移 */
            }
        }
        
        /* 平板样式 */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .side-text {
                font-size: clamp(24px, 5vw, 34px) !important; /* 减小字体大小 */
                line-height: 1.4;
            }
            .left-text-1 { 
                left: 8%; 
                top: 8%; /* 往上移 */
            }
            .left-text-3 { 
                left: 26%; 
                top: 20%; /* 往上移 */
            }
            .right-text-1 { 
                right: 8%; 
                top: 8%; /* 往上移 */
            }
            .right-text-3 { 
                right: 26%; 
                top: 20%; /* 往上移 */
            }
        }
        
        /* 小型笔记本电脑 */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .side-text {
                font-size: clamp(30px, 3.5vw, 46px);
                line-height: 1.5;
            }
            .left-text-1 { 
                left: calc(8% + 1vw); 
                top: 10%; /* 往上移 */
            }
            .left-text-3 { 
                left: calc(14% + 1vw); 
                top: 23%; /* 往上移 */
            }
            .right-text-1 { 
                right: calc(8% + 1vw); 
                top: 10%; /* 往上移 */
            }
            .right-text-3 { 
                right: calc(14% + 1vw); 
                top: 23%; /* 往上移 */
            }
        }
        
        /* 普通笔记本和台式显示器 */
        @media screen and (min-width: 1025px) and (max-width: 1440px) {
            .side-text {
                font-size: clamp(30px, 3.5vw, 48px);
                line-height: 1.5;
            }
            .left-text-1 { 
                left: calc(12% + 1vw); 
                top: 13%; /* 往上移 */
            }
            .left-text-3 { 
                left: calc(18% + 1vw); 
                top: 26%; /* 往上移 */
            }
            .right-text-1 { 
                right: calc(12% + 1vw); 
                top: 13%; /* 往上移 */
            }
            .right-text-3 { 
                right: calc(18% + 1vw); 
                top: 26%; /* 往上移 */
            }
        }
        
        /* 大屏幕显示器 */
        @media screen and (min-width: 1441px) and (max-width: 1920px) {
            .side-text {
                font-size: clamp(38px, 3vw, 50px);
                line-height: 1.5;
            }
            .left-text-1 { 
                left: calc(15% + 1vw); 
                top: 13%; /* 往上移 */
            }
            .left-text-3 { 
                left: calc(22% + 1vw); 
                top: 26%; /* 往上移 */
            }
            .right-text-1 { 
                right: calc(15% + 1vw); 
                top: 13%; /* 往上移 */
            }
            .right-text-3 { 
                right: calc(22% + 1vw); 
                top: 26%; /* 往上移 */
            }
        }

        .petal {
            position: fixed;
            pointer-events: none;
            width: 30px;
            height: 30px;
            z-index: 1000;
            animation: falling linear forwards;
        }

        .petal::before,
        .petal::after {
            content: '';
            position: absolute;
            top: 0;
            width: 50%;
            height: 80%;
            background: #f763ef;
            border-radius: 50% 50% 0 0;
        }

        .petal::before {
            left: 50%;
            transform: rotate(-45deg);
            transform-origin: 0 100%;
        }
        
        .petal::after {
            left: 0;
            transform: rotate(45deg);
            transform-origin: 100% 100%;
        }

        @keyframes falling {
            0% {
                transform: translate(0, -10%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-120vw, 120vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes flash {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>

<body>
    <!-- 加载指示器 -->
    <div class="loading-container" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <canvas id="canvas"></canvas>
    
    <!-- 音频背景音乐 -->
    <audio id="backgroundMusic" preload="auto" loop>
        <source src="River_flow_in_you.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- 心形文字容器 -->
    <div class="heart-container">
        <!-- 左侧垂直文字 -->
        <div class="side-text vertical-text left-text-1" id="left1">你走进了我的生命，我正在为你准备好一生一世</div>
        <div class="side-text vertical-text left-text-3" id="left3">愿得一人心，白首不相离</div>

        <!-- 心形文字 -->
        <div class="heart" id="heart-text">至死不渝的爱</div>
        <div class="name" id="name">亦辰</div>

        <!-- 右侧垂直文字 -->
        <div class="side-text vertical-text right-text-1" id="right1">我闯入了你的生活，你成为了我无法割舍的唯一</div>
        <div class="side-text vertical-text right-text-3" id="right3">此生得遇卿，方知人间值</div>
    </div>

    <canvas id="pinkboard"></canvas>

    <script>
        // 初始化画布
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');

        canvas.height = window.innerHeight;
        canvas.width = window.innerWidth;

        var texts = 'I LOVE U'.split('');
        var fontSize = 22;
        var columns = canvas.width / fontSize;
        var drops = [];

        for (var x = 0; x < columns; x++) {
            drops[x] = 1;
        }

        function draw() {
            // 降低背景的渐变速度，增加透明度
            ctx.fillStyle = 'rgba(0, 0, 0, 0.03)'; // 原来是 0.05
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#b300c4';
            ctx.font = fontSize + 'px arial';

            for (var i = 0; i < drops.length; i++) {
                var text = texts[Math.floor(Math.random() * texts.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height || Math.random() > 0.98) {
                    drops[i] = 0;
                }

                // 降低下落速度
                if (Math.random() > 0.3) { // 添加随机性，使下落更自然
                    drops[i]++;
                }
            }
        }

        // 性能优化：使用 requestAnimationFrame 并控制帧率
        let lastDrawTime = 0;
        const drawInterval = 50; // 每50ms绘制一次，原来是33ms

        function animate(currentTime) {
            if (currentTime - lastDrawTime > drawInterval) {
                draw();
                lastDrawTime = currentTime;
            }
            requestAnimationFrame(animate);
        }
        // 资源预加载
        const preloadResources = () => {
            const audio = document.getElementById('backgroundMusic');
            return new Promise((resolve) => {
                audio.load();
                if (audio.readyState >= 2) {
                    resolve();
                } else {
                    audio.addEventListener('canplaythrough', resolve, { once: true });
                }
            });
        };

        // 优化音频播放
        const initializeAudio = () => {
            const audio = document.getElementById('backgroundMusic');
            
            const playAudio = () => {
                audio.play().catch(error => {
                    console.log("播放音乐时出错: ", error);
                });
            };

            // 尝试自动播放
            playAudio();

            // 监听用户交互以播放音频
            document.addEventListener('click', () => {
                if (audio.paused) {
                    playAudio();
                }
            }, { once: true });
        };

        // 优化花瓣创建
        function createPetal() {
            const petal = document.createElement('div');
            petal.className = 'petal';

            // 根据屏幕宽度调整花瓣大小
            const isMobile = window.innerWidth <= 768;
            const size = isMobile ? 
                (Math.random() * 10 + 15) :  // 手机端 15-25px
                (Math.random() * 20 + 30);   // 桌面端 30-50px
            petal.style.width = `${size}px`;
            petal.style.height = `${size}px`;

            const startPositionX = Math.random() * 100;
            const startPositionY = Math.random() * 50 - 10;
            petal.style.right = `${startPositionX}%`;
            petal.style.top = `${startPositionY}%`;

            const duration = Math.random() * 5 + 7;
            petal.style.animationDuration = `${duration}s`;

            document.body.appendChild(petal);
            
            petal.addEventListener('animationend', () => {
                if (petal && petal.parentNode) {
                    petal.parentNode.removeChild(petal);
                }
            });
        }

        // 优化花瓣初始化
        function initializePetals() {
            const createPetalsInBatch = () => {
                const batchSize = 5;
                for (let i = 0; i < batchSize; i++) {
                    requestAnimationFrame(() => createPetal());
                }
            };

            createPetalsInBatch();
            setInterval(createPetalsInBatch, 2000);
        }

        // 优化文字显示动画
        async function showTextOneByOne(element) {
            if (!element) return;
            
            const text = element.innerText;
            element.innerText = "";
            element.style.display = "block";
            
            for (let i = 0; i < text.length; i++) {
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        element.innerText = text.substring(0, i + 1);
                        setTimeout(resolve, 180); // 控制每个字的显示速度
                    });
                });
            }
        }

        // 优化后的动画显示函数
        async function animateDisplay() {
            try {
                // 等待资源加载完成
                await preloadResources();
                
                // 隐藏加载界面
                const loading = document.getElementById('loading');
                loading.style.opacity = '0';
                loading.style.transition = 'opacity 0.5s';
                setTimeout(() => loading.style.display = 'none', 500);

                // 开始背景动画
                requestAnimationFrame(animate);

                // 初始化音频
                initializeAudio();

                // 初始化花瓣
                initializePetals();

                // 按顺序显示文字
                // 1. 首先同时显示 left1 和 right1
                await Promise.all([
                    showTextOneByOne(document.getElementById('left1')),
                    showTextOneByOne(document.getElementById('right1'))
                ]);
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒

                // 2. 然后同时显示 left3 和 right3
                await Promise.all([
                    showTextOneByOne(document.getElementById('left3')),
                    showTextOneByOne(document.getElementById('right3'))
                ]);
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒

                // 3. 显示名字
                await showTextOneByOne(document.getElementById('name'));
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒

                // 4. 显示心形文字
                while (true) {
                    await showTextOneByOne(document.getElementById('heart-text'));
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }

            } catch (e) {
                console.error('Error in animateDisplay:', e);
                // 出错时也要隐藏加载界面
                document.getElementById('loading').style.display = 'none';
            }
        }
        // 修改粒子系统配置
        var settings = {
            particles: {
                length: window.innerWidth <= 768 ? 450 : 500,
                duration: 2,
                velocity: 100,
                effect: -0.75,
                size: window.innerWidth <= 768 ? 25 : 30, // 进一步减小移动端粒子大小
            },
        };

        // Point 类定义
        var Point = (function() {
            function Point(x, y) {
                this.x = (typeof x !== 'undefined') ? x : 0;
                this.y = (typeof y !== 'undefined') ? y : 0;
            }
            Point.prototype.clone = function() {
                return new Point(this.x, this.y);
            };
            Point.prototype.length = function(length) {
                if (typeof length == 'undefined')
                    return Math.sqrt(this.x * this.x + this.y * this.y);
                this.normalize();
                this.x *= length;
                this.y *= length;
                return this;
            };
            Point.prototype.normalize = function() {
                var length = this.length();
                this.x /= length;
                this.y /= length;
                return this;
            };
            return Point;
        })();

        // 粒子类定义
        var Particle = (function() {
            function Particle() {
                this.position = new Point();
                this.velocity = new Point();
                this.acceleration = new Point();
                this.age = 0;
            }
            Particle.prototype.initialize = function(x, y, dx, dy) {
                this.position.x = x;
                this.position.y = y;
                this.velocity.x = dx;
                this.velocity.y = dy;
                this.acceleration.x = dx * settings.particles.effect;
                this.acceleration.y = dy * settings.particles.effect;
                this.age = 0;
            };
            Particle.prototype.update = function(deltaTime) {
                this.position.x += this.velocity.x * deltaTime;
                this.position.y += this.velocity.y * deltaTime;
                this.velocity.x += this.acceleration.x * deltaTime;
                this.velocity.y += this.acceleration.y * deltaTime;
                this.age += deltaTime;
            };
            Particle.prototype.draw = function(context, image) {
                function ease(t) {
                    return (--t) * t * t + 1;
                }
                var size = image.width * ease(this.age / settings.particles.duration);
                context.globalAlpha = 1 - this.age / settings.particles.duration;
                context.drawImage(image, this.position.x - size / 2, this.position.y - size / 2, size, size);
            };
            return Particle;
        })();

        // 粒子池
        var ParticlePool = (function() {
            var particles,
                firstActive = 0,
                firstFree = 0,
                duration = settings.particles.duration;

            function ParticlePool(length) {
                particles = new Array(length);
                for (var i = 0; i < particles.length; i++)
                    particles[i] = new Particle();
            }

            ParticlePool.prototype.add = function(x, y, dx, dy) {
                particles[firstFree].initialize(x, y, dx, dy);
                firstFree++;
                if (firstFree == particles.length) firstFree = 0;
                if (firstActive == firstFree) firstActive++;
                if (firstActive == particles.length) firstActive = 0;
            };

            ParticlePool.prototype.update = function(deltaTime) {
                var i;
                if (firstActive < firstFree) {
                    for (i = firstActive; i < firstFree; i++)
                        particles[i].update(deltaTime);
                }
                if (firstFree < firstActive) {
                    for (i = firstActive; i < particles.length; i++)
                        particles[i].update(deltaTime);
                    for (i = 0; i < firstFree; i++)
                        particles[i].update(deltaTime);
                }
                while (particles[firstActive].age >= duration && firstActive != firstFree) {
                    firstActive++;
                    if (firstActive == particles.length) firstActive = 0;
                }
            };

            ParticlePool.prototype.draw = function(context, image) {
                if (firstActive < firstFree) {
                    for (i = firstActive; i < firstFree; i++)
                        particles[i].draw(context, image);
                }
                if (firstFree < firstActive) {
                    for (i = firstActive; i < particles.length; i++)
                        particles[i].draw(context, image);
                    for (i = 0; i < firstFree; i++)
                        particles[i].draw(context, image);
                }
            };
            return ParticlePool;
        })();

        // 心形粒子动画
        (function(canvas) {
            var context = canvas.getContext('2d'),
                particles = new ParticlePool(settings.particles.length),
                particleRate = settings.particles.length / settings.particles.duration,
                time;

            // 根据屏幕大小计算缩放比例
            function getScale() {
                const width = window.innerWidth;
                if (width <= 480) return 0.25; // 超小屏幕
                if (width <= 768) return 0.35; // 手机屏幕
                if (width <= 1024) return 0.6; // 平板屏幕
                return 1; // 桌面屏幕
            }

            function pointOnHeart(t) {
                const scale = getScale();
                return new Point(
                    160 * Math.pow(Math.sin(t), 3) * scale,
                    (130 * Math.cos(t) - 50 * Math.cos(2 * t) - 20 * Math.cos(3 * t) - 10 * Math.cos(4 * t) + 25) * scale
                );
            }

            var image = (function() {
                var canvas = document.createElement('canvas'),
                    context = canvas.getContext('2d');
                canvas.width = settings.particles.size;
                canvas.height = settings.particles.size;

                // 调整心形绘制的缩放比例
                function to(t) {
                    var point = pointOnHeart(t);
                    point.x = settings.particles.size / 2 + point.x * settings.particles.size / (350 * (window.innerWidth <= 768 ? 1.2 : 1));
                    point.y = settings.particles.size / 2 - point.y * settings.particles.size / (350 * (window.innerWidth <= 768 ? 1.2 : 1));
                    return point;
                }

                context.beginPath();
                var t = -Math.PI;
                var point = to(t);
                context.moveTo(point.x, point.y);
                while (t < Math.PI) {
                    t += 0.01;
                    point = to(t);
                    context.lineTo(point.x, point.y);
                }
                context.closePath();
                context.fillStyle = '#c20cd3';
                context.fill();
                var image = new Image();
                image.src = canvas.toDataURL();
                return image;
            })();

            function render() {
                requestAnimationFrame(render);
                var newTime = new Date().getTime() / 1000,
                    deltaTime = newTime - (time || newTime);
                time = newTime;

                context.clearRect(0, 0, canvas.width, canvas.height);

                // 调整粒子生成的位置
                var amount = particleRate * deltaTime;
                for (var i = 0; i < amount; i++) {
                    var pos = pointOnHeart(Math.PI - 2 * Math.PI * Math.random());
                    var dir = pos.clone().length(settings.particles.velocity * (window.innerWidth <= 768 ? 0.7 : 1));
                    particles.add(canvas.width / 2 + pos.x, canvas.height / 2 - pos.y, dir.x, -dir.y);
                }

                particles.update(deltaTime);
                particles.draw(context, image);
            }

            // 优化 resize 处理
            function onResize() {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                settings.particles.size = window.innerWidth <= 768 ? 12 : 30;
                settings.particles.length = window.innerWidth <= 768 ? 300 : 500;
            }

            window.addEventListener('resize', onResize);
            onResize(); // 初始化时调用一次

            setTimeout(function() {
                render();
            }, 10);
        })(document.getElementById('pinkboard'));

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 使用 requestIdleCallback 在浏览器空闲时初始化
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => {
                    animateDisplay();
                });
            } else {
                setTimeout(animateDisplay, 0);
            }
        });

        // 添加错误处理
        window.addEventListener('error', function(e) {
            console.error('Resource loading error:', e.target.src || e.target.href);
        });
    </script>
</body>
</html>
